<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>40k Post-Game + Campaign Cycle</title>

  <style>
    :root{
      --bg0:#07080b;
      --bg1:#0b0e14;
      --ink:#e9e6dc;
      --muted:#b7b1a2;
      --dim:#7d776b;

      --gold:#d1a14b;
      --red:#cc3b3b;
      --green:#3fbf7f;
      --blue:#4aa6ff;

      --panel: rgba(10, 12, 18, 0.72);
      --panel2: rgba(14, 18, 26, 0.68);
      --stroke: rgba(209, 161, 75, 0.25);
      --stroke2: rgba(233, 230, 220, 0.10);

      --radius: 18px;
      --shadow: 0 20px 60px rgba(0,0,0,0.55);
      --safe: 72px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;

      --result-accent: var(--gold);

      /* Team colors (editable via editor with custom hex too) */
      --c-def: #d1a14b; /* Defenders */
      --c-att: #cc3b3b; /* Attackers */
      --c-rai: #4aa6ff; /* Raiders */
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--ink);
      background: radial-gradient(1200px 700px at 50% 25%, #121729 0%, var(--bg1) 40%, var(--bg0) 100%);
      overflow:hidden;
    }

    .noise{
      position: fixed; inset: 0; pointer-events: none; opacity: 0.10;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.08) 0 1px, transparent 2px),
        radial-gradient(circle at 60% 70%, rgba(255,255,255,.06) 0 1px, transparent 2px),
        radial-gradient(circle at 80% 20%, rgba(255,255,255,.05) 0 1px, transparent 2px),
        radial-gradient(circle at 30% 80%, rgba(255,255,255,.06) 0 1px, transparent 2px);
      background-size: 420px 420px, 540px 540px, 680px 680px, 760px 760px;
      filter: blur(0.1px);
    }

    .scanlines{
      position: fixed; inset: 0; pointer-events: none; opacity: 0.25;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,0.05),
        rgba(255,255,255,0.05) 1px,
        rgba(0,0,0,0) 4px,
        rgba(0,0,0,0) 7px
      );
      mix-blend-mode: overlay;
    }

    .flicker{
      position: fixed; inset: 0; pointer-events: none;
      animation: flicker 7s infinite;
      background: radial-gradient(700px 420px at 50% 30%, rgba(209,161,75,0.06), transparent 55%);
      opacity: 0.45;
    }
    @keyframes flicker{
      0%, 100% { opacity: 0.26; }
      7% { opacity: 0.38; }
      12% { opacity: 0.22; }
      23% { opacity: 0.44; }
      27% { opacity: 0.30; }
      51% { opacity: 0.36; }
      64% { opacity: 0.24; }
      78% { opacity: 0.40; }
    }

    .stage{ position: fixed; inset: 0; display:grid; place-items:center; }
    .wrap{
      width: 1920px; height: 1080px; position: relative; transform-origin: top left;
    }

    .frame{
      position: absolute;
      inset: var(--safe);
      border-radius: calc(var(--radius) + 8px);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(0,0,0,0.10));
      box-shadow: var(--shadow);
      border: 1px solid var(--stroke2);
      overflow: hidden;
    }
    .frame::before{
      content:"";
      position:absolute;
      inset: -2px;
      border-radius: calc(var(--radius) + 10px);
      border: 2px solid var(--stroke);
      opacity: 0.7;
      pointer-events:none;
    }

    .header{
      position:absolute; top:0; left:0; right:0;
      padding: 22px 28px;
      background: linear-gradient(90deg, rgba(209,161,75,0.16), rgba(209,161,75,0.06) 55%, rgba(233,230,220,0.02));
      border-bottom: 1px solid var(--stroke2);
      display:flex; align-items: baseline; justify-content: space-between; gap: 18px;
    }
    .title{
      letter-spacing: 0.14em;
      text-transform: uppercase;
      font-weight: 800;
      font-size: 18px;
      color: rgba(233,230,220,0.92);
    }
    .sub{
      font-family: var(--mono);
      font-size: 14px;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      color: rgba(233,230,220,0.62);
      white-space: nowrap;
    }

    .content{
      position:absolute;
      top: 86px; left:0; right:0; bottom:0;
      padding: 28px;
      display:grid;
      grid-template-columns: 1.25fr 0.75fr;
      gap: 22px;
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--stroke2);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .card .card-h{
      padding: 16px 18px;
      border-bottom: 1px solid rgba(233,230,220,0.08);
      background: linear-gradient(180deg, rgba(233,230,220,0.03), transparent);
      display:flex; align-items:center; justify-content: space-between; gap:14px;
    }
    .label{
      font-family: var(--mono);
      font-size: 13px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(233,230,220,0.65);
    }
    .pill{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(233,230,220,0.12);
      color: rgba(233,230,220,0.8);
      background: rgba(0,0,0,0.28);
      white-space: nowrap;
    }

    /* LEFT: post-game declaration */
    .result{
      padding: 24px 22px 18px;
      display:grid;
      gap: 16px;
    }
    .result-top{
      display:grid; gap:8px; text-align:center; padding-top: 8px;
    }
    .result-kicker{
      font-family: var(--mono);
      text-transform: uppercase;
      letter-spacing: 0.20em;
      font-size: 13px;
      color: rgba(233,230,220,0.55);
    }
    .result-main{
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-weight: 900;
      font-size: 54px;
      color: var(--result-accent);
      text-shadow: 0 0 22px rgba(209,161,75,0.12);
      line-height: 1.05;
    }
    .result-winner{
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 800;
      font-size: 20px;
      color: rgba(233,230,220,0.92);
    }

    .versus{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap: 14px;
      padding-top: 6px;
    }
    .side{
      border-radius: 16px;
      border: 1px solid rgba(233,230,220,0.10);
      background: rgba(0,0,0,0.20);
      padding: 14px 14px 12px;
      display:grid; gap:8px;
    }
    .side-name{
      font-weight: 850;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 17px;
      color: rgba(233,230,220,0.92);
    }
    .side-sub{
      font-family: var(--mono);
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-size: 12px;
      color: rgba(233,230,220,0.58);
    }
    .vs{
      font-family: var(--mono);
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: rgba(233,230,220,0.58);
      font-size: 13px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(233,230,220,0.12);
      background: rgba(0,0,0,0.22);
    }

    .grid{
      padding: 18px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .kv{
      background: rgba(0,0,0,0.20);
      border: 1px solid rgba(233,230,220,0.10);
      border-radius: 14px;
      padding: 12px 12px 10px;
      display:grid;
      gap: 6px;
      min-height: 70px;
    }
    .k{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(233,230,220,0.55);
    }
    .v{
      font-weight: 720;
      letter-spacing: 0.02em;
      color: rgba(233,230,220,0.92);
      font-size: 15px;
      line-height: 1.25;
    }
    .v.mono{ font-family: var(--mono); font-weight: 650; font-size: 14px; }

    /* RIGHT: cycling installation + countdown */
    .right{
      display:grid;
      grid-template-rows: auto auto 1fr;
      gap: 22px;
    }

    .install{
      padding: 16px 18px 18px;
      display:grid;
      gap: 14px;
    }

    .install-head{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 14px;
    }
    .install-name{
      font-weight: 900;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 22px;
      color: rgba(233,230,220,0.95);
      line-height: 1.1;
    }
    .install-meta{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(233,230,220,0.58);
      white-space: nowrap;
    }

    .bars{
      display:grid;
      gap: 10px;
    }
    .bar-row{
      display:grid;
      grid-template-columns: 170px 1fr 54px;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(233,230,220,0.10);
    }
    .team{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(233,230,220,0.78);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .track{
      height: 12px;
      border-radius: 999px;
      background: rgba(233,230,220,0.08);
      border: 1px solid rgba(233,230,220,0.10);
      overflow:hidden;
      position: relative;
    }
    .fill{
      position:absolute; left:0; top:0; bottom:0;
      width: 0%;
      border-radius: 999px;
      filter: saturate(1.05);
      opacity: 0.95;
      transition: width 500ms ease;
    }
    .pct{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(233,230,220,0.82);
      text-align: right;
    }

    .fill.def{ background: var(--c-def); box-shadow: 0 0 18px rgba(209,161,75,0.14); }
    .fill.att{ background: var(--c-att); box-shadow: 0 0 18px rgba(204,59,59,0.14); }
    .fill.rai{ background: var(--c-rai); box-shadow: 0 0 18px rgba(74,166,255,0.14); }

    .install-footer{
      display:flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      padding-top: 2px;
    }
    .hint-mini{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(233,230,220,0.50);
    }

    /* Countdown card */
    .countdown{
      padding: 18px;
      display:grid;
      gap: 12px;
    }
    .timer-row{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
    }
    .timer-label{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(233,230,220,0.62);
    }
    .timer-big{
      font-family: var(--mono);
      font-size: 46px;
      letter-spacing: 0.12em;
      font-weight: 900;
      color: rgba(233,230,220,0.94);
      text-shadow: 0 0 18px rgba(0,0,0,0.35);
      line-height: 1.0;
    }
    .timer-sub{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(233,230,220,0.55);
    }
    .timer-hidden{ display:none !important; }

    /* Outcome list (still here, but now “Post-Game Notes”) */
    .list{
      padding: 18px 18px 16px;
      display:grid;
      gap: 12px;
    }
    .line{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(233,230,220,0.10);
    }
    .dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      margin-top: 5px;
      background: var(--result-accent);
      box-shadow: 0 0 10px rgba(209,161,75,0.2);
      flex: 0 0 auto;
    }
    .txt{
      color: rgba(233,230,220,0.88);
      font-size: 15px;
      letter-spacing: 0.01em;
      line-height: 1.25;
    }

    .corner{
      position:absolute;
      bottom: 18px;
      left: 20px;
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(233,230,220,0.38);
    }

    .hidden{ display:none !important; }

    /* EDITOR */
    .editor{
      position: absolute;
      right: 22px;
      top: 108px;
      width: 560px;
      max-height: calc(1080px - 140px);
      overflow: auto;
      border-radius: 18px;
      border: 1px solid rgba(233,230,220,0.14);
      background: rgba(8,10,14,0.86);
      box-shadow: 0 20px 70px rgba(0,0,0,0.65);
      padding: 14px;
      z-index: 20;
      backdrop-filter: blur(6px);
    }
    .editor h3{
      margin: 6px 6px 10px;
      font-size: 14px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      font-family: var(--mono);
      color: rgba(233,230,220,0.78);
    }
    .hint{
      margin: 0 6px 10px;
      color: rgba(233,230,220,0.55);
      font-size: 12px;
      line-height: 1.35;
      font-family: var(--mono);
      letter-spacing: 0.06em;
    }
    .editor .row{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(233,230,220,0.08);
      background: rgba(0,0,0,0.24);
      margin: 8px 6px;
    }
    .editor label{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(233,230,220,0.62);
    }
    .editor input, .editor textarea, .editor select{
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(233,230,220,0.12);
      background: rgba(10,12,18,0.60);
      color: rgba(233,230,220,0.92);
      padding: 10px 10px;
      font-size: 14px;
      outline: none;
    }
    .editor textarea{ min-height: 66px; resize: vertical; }
    .editor .btns{
      display:flex;
      gap: 10px;
      padding: 10px 6px 6px;
      flex-wrap: wrap;
    }
    .btn{
      border-radius: 12px;
      border: 1px solid rgba(233,230,220,0.14);
      background: rgba(0,0,0,0.30);
      color: rgba(233,230,220,0.86);
      padding: 10px 12px;
      font-family: var(--mono);
      letter-spacing: 0.10em;
      text-transform: uppercase;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
    }
    .btn.primary{
      border-color: rgba(209,161,75,0.35);
      background: rgba(209,161,75,0.14);
      color: rgba(233,230,220,0.95);
    }
  </style>
</head>

<body>
  <div class="noise"></div>
  <div class="scanlines"></div>
  <div class="flicker"></div>

  <div class="stage">
    <div class="wrap" id="wrap">
      <div class="frame">
        <div class="header">
          <div class="title" id="hdrTitle">CAMPAIGN RECORD: BASTIOR SUB-SECTOR</div>
          <div class="sub" id="hdrStamp">AFTER-ACTION LOG • 0041.M42 • TURN 3</div>
        </div>

        <div class="content">
          <!-- LEFT: POST-GAME -->
          <div class="card">
            <div class="card-h">
              <div class="label">Post-Engagement Declaration</div>
              <div class="pill" id="pillMode">FINAL REPORT</div>
            </div>

            <div class="result">
              <div class="result-top">
                <div class="result-kicker" id="resultKicker">VICTORY DECLARED</div>
                <div class="result-main" id="resultMain">VICTORY</div>
                <div class="result-winner" id="resultWinner">DEFENDERS OF BASTIOR</div>
              </div>

              <div class="versus">
                <div class="side">
                  <div class="side-name" id="leftFaction">IMPERIUM OF MAN</div>
                  <div class="side-sub" id="leftPlayer">Commander: Player One</div>
                </div>
                <div class="vs">VS</div>
                <div class="side">
                  <div class="side-name" id="rightFaction">CHAOS</div>
                  <div class="side-sub" id="rightPlayer">Commander: Player Two</div>
                </div>
              </div>
            </div>

            <div class="grid">
              <div class="kv">
                <div class="k">Mission</div>
                <div class="v" id="missionName">SUPPLY RAID</div>
              </div>
              <div class="kv">
                <div class="k">Theater</div>
                <div class="v" id="missionTheater">Bastior Prime – Manufactorum District</div>
              </div>
              <div class="kv">
                <div class="k">Score</div>
                <div class="v mono" id="scoreLine">86–72 (VP)</div>
              </div>
              <div class="kv">
                <div class="k">Campaign Turn</div>
                <div class="v mono" id="roundLine">Turn 3</div>
              </div>
            </div>

            <div class="corner" id="cornerTag">Administratum Copy • Verified</div>
          </div>

          <!-- RIGHT: INSTALLATION CYCLE + COUNTDOWN + NOTES -->
          <div class="right">
            <div class="card">
              <div class="card-h">
                <div class="label">Territory Control</div>
                <div class="pill" id="cyclePill">CYCLING INSTALLATIONS</div>
              </div>

              <div class="install">
                <div class="install-head">
                  <div class="install-name" id="instName">Bastior Prime</div>
                  <div class="install-meta" id="instMeta">1 / 6 • Every 8s</div>
                </div>

                <div class="bars">
                  <div class="bar-row">
                    <div class="team" id="teamDefName">Defenders</div>
                    <div class="track"><div class="fill def" id="barDef"></div></div>
                    <div class="pct" id="pctDef">100%</div>
                  </div>

                  <div class="bar-row">
                    <div class="team" id="teamAttName">Attackers</div>
                    <div class="track"><div class="fill att" id="barAtt"></div></div>
                    <div class="pct" id="pctAtt">0%</div>
                  </div>

                  <div class="bar-row">
                    <div class="team" id="teamRaiName">Raiders</div>
                    <div class="track"><div class="fill rai" id="barRai"></div></div>
                    <div class="pct" id="pctRai">0%</div>
                  </div>
                </div>

                <div class="install-footer">
                  <div class="hint-mini" id="instHint">Warp lanes contested. Supply lines unstable.</div>
                  <div class="hint-mini" id="cycleHint">Ctrl+E edit</div>
                </div>
              </div>
            </div>

            <div class="card" id="countdownCard">
              <div class="card-h">
                <div class="label">Next Match Countdown</div>
                <div class="pill" id="timerPill">OPTIONAL</div>
              </div>
              <div class="countdown">
                <div class="timer-row">
                  <div>
                    <div class="timer-label" id="timerLabel">NEXT ENGAGEMENT IN</div>
                    <div class="timer-sub" id="timerSub">Ctrl+Space start/pause • Ctrl+T hide/show</div>
                  </div>
                  <div class="timer-big" id="timerBig">05:00</div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-h">
                <div class="label">Post-Game Notes</div>
                <div class="pill" id="notesPill">RECORDED</div>
              </div>
              <div class="list" id="notesList"></div>
            </div>
          </div>
        </div>

        <!-- EDITOR -->
        <div class="editor hidden" id="editor">
          <h3>Overlay Editor</h3>
          <div class="hint">
            Ctrl+E toggles editor. Ctrl+Space starts/pauses timer. Ctrl+T toggles timer visibility.
            Changes auto-save locally. Use Export/Import for presets. Add <b>?reset=1</b> to clear saved data.
          </div>

          <div class="row">
            <label>Header Title</label>
            <input id="e_hdrTitle" type="text" />
          </div>
          <div class="row">
            <label>Header Stamp</label>
            <input id="e_hdrStamp" type="text" />
          </div>

          <div class="row">
            <label>Result Kicker</label>
            <input id="e_resultKicker" type="text" />
            <label>Result Main (big word)</label>
            <input id="e_resultMain" type="text" />
            <label>Winner Line</label>
            <input id="e_resultWinner" type="text" />
          </div>

          <div class="row">
            <label>Result Accent Color</label>
            <select id="e_resultAccent">
              <option value="gold">Gold (default)</option>
              <option value="green">Green</option>
              <option value="red">Red</option>
              <option value="custom">Custom (hex)</option>
            </select>
            <input id="e_customAccent" type="text" placeholder="#d1a14b" />
          </div>

          <div class="row">
            <label>Left Faction</label>
            <input id="e_leftFaction" type="text" />
            <label>Left Commander</label>
            <input id="e_leftPlayer" type="text" />
          </div>

          <div class="row">
            <label>Right Faction</label>
            <input id="e_rightFaction" type="text" />
            <label>Right Commander</label>
            <input id="e_rightPlayer" type="text" />
          </div>

          <div class="row">
            <label>Mission Name</label>
            <input id="e_missionName" type="text" />
            <label>Theater</label>
            <input id="e_missionTheater" type="text" />
          </div>

          <div class="row">
            <label>Score Line</label>
            <input id="e_scoreLine" type="text" />
            <label>Campaign Turn</label>
            <input id="e_roundLine" type="text" />
          </div>

          <div class="row">
            <label>Team Names</label>
            <input id="e_teamDefName" type="text" placeholder="Defenders" />
            <input id="e_teamAttName" type="text" placeholder="Attackers" />
            <input id="e_teamRaiName" type="text" placeholder="Raiders" />
          </div>

          <div class="row">
            <label>Team Colors (hex)</label>
            <input id="e_cDef" type="text" placeholder="#d1a14b" />
            <input id="e_cAtt" type="text" placeholder="#cc3b3b" />
            <input id="e_cRai" type="text" placeholder="#4aa6ff" />
          </div>

          <div class="row">
            <label>Cycle Interval (seconds)</label>
            <input id="e_cycleSeconds" type="number" min="2" step="1" />
            <label>Installation Hint Line (shown under bars)</label>
            <input id="e_instHint" type="text" />
          </div>

          <div class="row">
            <label>Installations (one per line, format: Name | Def% | Att% | Rai%)</label>
            <textarea id="e_installations"></textarea>
          </div>

          <div class="row">
            <label>Countdown Visible?</label>
            <select id="e_timerVisible">
              <option value="1">Yes</option>
              <option value="0">No</option>
            </select>
            <label>Countdown Label</label>
            <input id="e_timerLabel" type="text" />
            <label>Countdown Start (MM:SS)</label>
            <input id="e_timerStart" type="text" placeholder="05:00" />
            <label>Auto-hide countdown at 00:00?</label>
            <select id="e_timerAutoHide">
              <option value="1">Yes</option>
              <option value="0">No</option>
            </select>
          </div>

          <div class="row">
            <label>Post-Game Notes (one per line)</label>
            <textarea id="e_notes"></textarea>
          </div>

          <div class="row">
            <label>Corner Tag</label>
            <input id="e_cornerTag" type="text" />
          </div>

          <div class="btns">
            <button class="btn primary" id="btnApply">Apply</button>
            <button class="btn" id="btnPrev">Prev Install</button>
            <button class="btn" id="btnNext">Next Install</button>
            <button class="btn" id="btnStartPause">Start/Pause Timer</button>
            <button class="btn" id="btnResetTimer">Reset Timer</button>
            <button class="btn" id="btnExport">Export JSON</button>
            <button class="btn" id="btnImport">Import JSON</button>
            <button class="btn" id="btnClear">Clear Saved</button>
            <button class="btn" id="btnClose">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "bastior_postgame_campaign_cycle_v1";

    const DEFAULTS = {
      hdrTitle: "CAMPAIGN RECORD: BASTIOR SUB-SECTOR",
      hdrStamp: "AFTER-ACTION LOG • 0041.M42 • TURN 3",
      pillMode: "FINAL REPORT",

      resultKicker: "VICTORY DECLARED",
      resultMain: "VICTORY",
      resultWinner: "DEFENDERS OF BASTIOR",
      accentMode: "gold",        // gold | green | red | custom
      accentCustom: "#d1a14b",

      leftFaction: "IMPERIUM OF MAN",
      leftPlayer: "Commander: Player One",
      rightFaction: "CHAOS",
      rightPlayer: "Commander: Player Two",

      missionName: "SUPPLY RAID",
      missionTheater: "Bastior Prime – Manufactorum District",
      scoreLine: "86–72 (VP)",
      roundLine: "Turn 3",

      teamDefName: "Defenders",
      teamAttName: "Attackers",
      teamRaiName: "Raiders",

      cDef: "#d1a14b",
      cAtt: "#cc3b3b",
      cRai: "#4aa6ff",

      cycleSeconds: 8,
      instHint: "Warp lanes contested. Supply lines unstable.",
      installations: [
        { name: "Bastior Prime", def: 100, att: 0,  rai: 0  },
        { name: "Trinaxis Minor", def: 75,  att: 25, rai: 0  },
        { name: "Aurum Refuge", def: 75,  att: 0,  rai: 25 },
        { name: "Harkanis", def: 0,  att: 75, rai: 25 },
        { name: "Karst Forge", def: 25, att: 75, rai: 0  },
        { name: "Void Bastion", def: 0,  att: 25, rai: 75 }
      ],

      timerVisible: true,
      timerLabel: "NEXT ENGAGEMENT IN",
      timerStartSeconds: 300,      // 05:00
      timerAutoHide: true,

      notes: [
        "Bastior Prime secured at full control.",
        "Orbital defense grid reactivated.",
        "Warp route stability improved (temporary)."
      ],

      cornerTag: "Administratum Copy • Verified"
    };

    const $ = (id) => document.getElementById(id);
    const qs = (name) => new URLSearchParams(location.search).get(name);

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function parseMMSS(s){
      const m = String(s || "").trim().match(/^(\d{1,3}):(\d{2})$/);
      if (!m) return null;
      const mm = parseInt(m[1],10);
      const ss = parseInt(m[2],10);
      if (Number.isNaN(mm) || Number.isNaN(ss)) return null;
      return clamp(mm,0,999)*60 + clamp(ss,0,59);
    }

    function fmtMMSS(total){
      total = Math.max(0, Math.floor(total));
      const mm = Math.floor(total / 60);
      const ss = total % 60;
      return String(mm).padStart(2,"0") + ":" + String(ss).padStart(2,"0");
    }

    function safeJsonParse(raw){
      try{ return JSON.parse(raw); } catch(e){ return null; }
    }

    function normalizeData(obj){
      const d = { ...DEFAULTS, ...(obj || {}) };

      // Ensure installations array
      if (!Array.isArray(d.installations)) d.installations = DEFAULTS.installations.slice();
      d.installations = d.installations
        .map(x => ({
          name: String(x?.name ?? "").trim() || "Unknown",
          def: clamp(parseInt(x?.def ?? 0, 10) || 0, 0, 100),
          att: clamp(parseInt(x?.att ?? 0, 10) || 0, 0, 100),
          rai: clamp(parseInt(x?.rai ?? 0, 10) || 0, 0, 100),
        }))
        .filter(x => x.name.length);

      if (!d.installations.length) d.installations = DEFAULTS.installations.slice();

      // Notes
      if (!Array.isArray(d.notes)) {
        d.notes = String(d.notes || "").split("\n").map(s=>s.trim()).filter(Boolean);
      }
      d.notes = d.notes.map(s=>String(s).trim()).filter(Boolean);

      d.cycleSeconds = clamp(parseInt(d.cycleSeconds,10) || DEFAULTS.cycleSeconds, 2, 120);

      d.timerVisible = !!d.timerVisible;
      d.timerAutoHide = !!d.timerAutoHide;
      d.timerStartSeconds = clamp(parseInt(d.timerStartSeconds,10) || DEFAULTS.timerStartSeconds, 0, 24*60*60);

      d.cDef = String(d.cDef || DEFAULTS.cDef).trim();
      d.cAtt = String(d.cAtt || DEFAULTS.cAtt).trim();
      d.cRai = String(d.cRai || DEFAULTS.cRai).trim();

      return d;
    }

    function applyAccent(data){
      let color = "var(--gold)";
      if (data.accentMode === "green") color = "var(--green)";
      if (data.accentMode === "red") color = "var(--red)";
      if (data.accentMode === "custom" && data.accentCustom) color = data.accentCustom;
      document.documentElement.style.setProperty("--result-accent", color);
    }

    function applyTeamColors(data){
      document.documentElement.style.setProperty("--c-def", data.cDef || DEFAULTS.cDef);
      document.documentElement.style.setProperty("--c-att", data.cAtt || DEFAULTS.cAtt);
      document.documentElement.style.setProperty("--c-rai", data.cRai || DEFAULTS.cRai);
    }

    function setText(id, val){
      const el = $(id);
      if (el) el.textContent = (val ?? "").toString();
    }

    function renderNotes(lines){
      const el = $("notesList");
      el.innerHTML = "";
      (lines || []).forEach(line => {
        const row = document.createElement("div");
        row.className = "line";
        row.innerHTML = `<div class="dot"></div><div class="txt"></div>`;
        row.querySelector(".txt").textContent = line;
        el.appendChild(row);
      });
    }

    function loadStored(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      return safeJsonParse(raw);
    }

    function saveStored(data){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function clearStored(){
      localStorage.removeItem(STORAGE_KEY);
    }

    // -------------------------
    // Cycling state
    // -------------------------
    let state = {
      data: normalizeData(DEFAULTS),
      index: 0,
      cycleTimer: null,

      countdownVisible: true,
      countdownRunning: false,
      countdownLeft: 0,
      countdownTick: null
    };

    function renderInstallation(){
      const d = state.data;
      const list = d.installations;
      const idx = clamp(state.index, 0, Math.max(0, list.length - 1));
      const inst = list[idx];

      setText("instName", inst.name);
      setText("instMeta", `${idx + 1} / ${list.length} • Every ${d.cycleSeconds}s`);
      setText("instHint", d.instHint);

      setText("teamDefName", d.teamDefName);
      setText("teamAttName", d.teamAttName);
      setText("teamRaiName", d.teamRaiName);

      $("barDef").style.width = inst.def + "%";
      $("barAtt").style.width = inst.att + "%";
      $("barRai").style.width = inst.rai + "%";

      setText("pctDef", inst.def + "%");
      setText("pctAtt", inst.att + "%");
      setText("pctRai", inst.rai + "%");
    }

    function stopCycle(){
      if (state.cycleTimer) clearInterval(state.cycleTimer);
      state.cycleTimer = null;
    }

    function startCycle(){
      stopCycle();
      state.cycleTimer = setInterval(() => {
        state.index = (state.index + 1) % state.data.installations.length;
        renderInstallation();
      }, state.data.cycleSeconds * 1000);
    }

    function nextInstall(){
      state.index = (state.index + 1) % state.data.installations.length;
      renderInstallation();
    }

    function prevInstall(){
      state.index = (state.index - 1 + state.data.installations.length) % state.data.installations.length;
      renderInstallation();
    }

    // -------------------------
    // Countdown
    // -------------------------
    function setCountdownVisible(v){
      state.countdownVisible = !!v;
      $("countdownCard").classList.toggle("timer-hidden", !state.countdownVisible);
    }

    function renderCountdown(){
      setText("timerLabel", state.data.timerLabel);
      setText("timerBig", fmtMMSS(state.countdownLeft));
      // Auto hide at 0 if enabled
      if (state.countdownLeft <= 0 && state.data.timerAutoHide){
        setCountdownVisible(false);
        state.countdownRunning = false;
      }
    }

    function stopCountdownTick(){
      if (state.countdownTick) clearInterval(state.countdownTick);
      state.countdownTick = null;
    }

    function startCountdownTick(){
      stopCountdownTick();
      state.countdownTick = setInterval(() => {
        if (!state.countdownRunning) return;
        state.countdownLeft = Math.max(0, state.countdownLeft - 1);
        renderCountdown();
        if (state.countdownLeft <= 0){
          state.countdownRunning = false;
        }
      }, 1000);
    }

    function toggleCountdownRun(){
      // If hidden and user starts it, show it
      if (!state.countdownVisible) setCountdownVisible(true);
      state.countdownRunning = !state.countdownRunning;
    }

    function resetCountdown(){
      state.countdownLeft = state.data.timerStartSeconds;
      state.countdownRunning = false;
      if (state.data.timerAutoHide) {
        // don’t force show; but if hidden, keep hidden
        // if visible, keep visible
      }
      renderCountdown();
    }

    // -------------------------
    // Main render
    // -------------------------
    function renderAll(data){
      data = normalizeData(data);
      state.data = data;

      setText("hdrTitle", data.hdrTitle);
      setText("hdrStamp", data.hdrStamp);
      setText("pillMode", data.pillMode);

      setText("resultKicker", data.resultKicker);
      setText("resultMain", data.resultMain);
      setText("resultWinner", data.resultWinner);

      setText("leftFaction", data.leftFaction);
      setText("leftPlayer", data.leftPlayer);
      setText("rightFaction", data.rightFaction);
      setText("rightPlayer", data.rightPlayer);

      setText("missionName", data.missionName);
      setText("missionTheater", data.missionTheater);
      setText("scoreLine", data.scoreLine);
      setText("roundLine", data.roundLine);

      setText("cornerTag", data.cornerTag);

      applyAccent(data);
      applyTeamColors(data);

      // Notes
      renderNotes(data.notes);

      // Installation cycle
      state.index = clamp(state.index, 0, data.installations.length - 1);
      renderInstallation();
      startCycle();

      // Countdown
      setCountdownVisible(data.timerVisible);
      // Keep remaining time if already running; otherwise reset to start
      if (!state.countdownTick) startCountdownTick();
      if (!state.countdownRunning && state.countdownLeft === 0) {
        state.countdownLeft = data.timerStartSeconds;
      }
      renderCountdown();

      return data;
    }

    // -------------------------
    // Editor
    // -------------------------
    function openEditor(open){
      $("editor").classList.toggle("hidden", !open);
    }

    function installationsToText(list){
      return (list || []).map(x => `${x.name} | ${x.def} | ${x.att} | ${x.rai}`).join("\n");
    }

    function textToInstallations(txt){
      const lines = String(txt || "").split("\n").map(s=>s.trim()).filter(Boolean);
      const out = [];
      for (const line of lines){
        const parts = line.split("|").map(s=>s.trim());
        if (!parts.length) continue;
        const name = parts[0] || "Unknown";
        const def = clamp(parseInt(parts[1] ?? "0",10) || 0, 0, 100);
        const att = clamp(parseInt(parts[2] ?? "0",10) || 0, 0, 100);
        const rai = clamp(parseInt(parts[3] ?? "0",10) || 0, 0, 100);
        out.push({ name, def, att, rai });
      }
      return out.length ? out : DEFAULTS.installations.slice();
    }

    function fillEditor(d){
      d = normalizeData(d);

      $("e_hdrTitle").value = d.hdrTitle;
      $("e_hdrStamp").value = d.hdrStamp;

      $("e_resultKicker").value = d.resultKicker;
      $("e_resultMain").value = d.resultMain;
      $("e_resultWinner").value = d.resultWinner;

      $("e_resultAccent").value = d.accentMode;
      $("e_customAccent").value = d.accentCustom || "";

      $("e_leftFaction").value = d.leftFaction;
      $("e_leftPlayer").value = d.leftPlayer;
      $("e_rightFaction").value = d.rightFaction;
      $("e_rightPlayer").value = d.rightPlayer;

      $("e_missionName").value = d.missionName;
      $("e_missionTheater").value = d.missionTheater;

      $("e_scoreLine").value = d.scoreLine;
      $("e_roundLine").value = d.roundLine;

      $("e_teamDefName").value = d.teamDefName;
      $("e_teamAttName").value = d.teamAttName;
      $("e_teamRaiName").value = d.teamRaiName;

      $("e_cDef").value = d.cDef;
      $("e_cAtt").value = d.cAtt;
      $("e_cRai").value = d.cRai;

      $("e_cycleSeconds").value = d.cycleSeconds;
      $("e_instHint").value = d.instHint;

      $("e_installations").value = installationsToText(d.installations);

      $("e_timerVisible").value = d.timerVisible ? "1" : "0";
      $("e_timerLabel").value = d.timerLabel;
      $("e_timerStart").value = fmtMMSS(d.timerStartSeconds);
      $("e_timerAutoHide").value = d.timerAutoHide ? "1" : "0";

      $("e_notes").value = (d.notes || []).join("\n");

      $("e_cornerTag").value = d.cornerTag;
    }

    function readEditor(){
      const timerStart = parseMMSS($("e_timerStart").value) ?? DEFAULTS.timerStartSeconds;

      return normalizeData({
        hdrTitle: $("e_hdrTitle").value,
        hdrStamp: $("e_hdrStamp").value,

        resultKicker: $("e_resultKicker").value,
        resultMain: $("e_resultMain").value,
        resultWinner: $("e_resultWinner").value,

        accentMode: $("e_resultAccent").value,
        accentCustom: $("e_customAccent").value.trim(),

        leftFaction: $("e_leftFaction").value,
        leftPlayer: $("e_leftPlayer").value,
        rightFaction: $("e_rightFaction").value,
        rightPlayer: $("e_rightPlayer").value,

        missionName: $("e_missionName").value,
        missionTheater: $("e_missionTheater").value,

        scoreLine: $("e_scoreLine").value,
        roundLine: $("e_roundLine").value,

        teamDefName: $("e_teamDefName").value,
        teamAttName: $("e_teamAttName").value,
        teamRaiName: $("e_teamRaiName").value,

        cDef: $("e_cDef").value,
        cAtt: $("e_cAtt").value,
        cRai: $("e_cRai").value,

        cycleSeconds: parseInt($("e_cycleSeconds").value, 10),
        instHint: $("e_instHint").value,

        installations: textToInstallations($("e_installations").value),

        timerVisible: $("e_timerVisible").value === "1",
        timerLabel: $("e_timerLabel").value,
        timerStartSeconds: timerStart,
        timerAutoHide: $("e_timerAutoHide").value === "1",

        notes: $("e_notes").value.split("\n"),

        cornerTag: $("e_cornerTag").value
      });
    }

    function downloadJson(filename, obj){
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function promptImport(){
      const raw = prompt("Paste overlay JSON here:");
      if (!raw) return null;
      const parsed = safeJsonParse(raw);
      if (!parsed) alert("Invalid JSON.");
      return parsed;
    }

    // -------------------------
    // Init
    // -------------------------
    (function init(){
      // Fit 1920x1080 to viewport
      const wrap = $("wrap");
      function fit(){
        const w = window.innerWidth, h = window.innerHeight;
        const s = Math.min(w/1920, h/1080);
        wrap.style.transform = `scale(${s})`;
      }
      window.addEventListener("resize", fit);
      fit();

      if (qs("reset") === "1") clearStored();

      const stored = loadStored();
      const initial = normalizeData(stored || DEFAULTS);
      state.data = initial;
      // initialize countdown from stored start
      state.countdownLeft = initial.timerStartSeconds;
      setCountdownVisible(initial.timerVisible);

      const rendered = renderAll(initial);
      saveStored(rendered);
      fillEditor(rendered);

      if (qs("edit") === "1") openEditor(true);

      // Buttons
      $("btnApply").addEventListener("click", () => {
        const d = readEditor();

        // If user changes start time, reset countdown to that start
        const prevStart = state.data.timerStartSeconds;
        const nextStart = d.timerStartSeconds;
        const startChanged = prevStart !== nextStart;

        const next = renderAll(d);
        saveStored(next);
        fillEditor(next);

        if (startChanged){
          state.countdownLeft = next.timerStartSeconds;
          state.countdownRunning = false;
          renderCountdown();
        }
      });

      $("btnPrev").addEventListener("click", () => { prevInstall(); });
      $("btnNext").addEventListener("click", () => { nextInstall(); });

      $("btnStartPause").addEventListener("click", () => { toggleCountdownRun(); });
      $("btnResetTimer").addEventListener("click", () => { resetCountdown(); });

      $("btnExport").addEventListener("click", () => {
        const d = readEditor();
        downloadJson("postgame-campaign-export.json", d);
      });

      $("btnImport").addEventListener("click", () => {
        const imported = promptImport();
        if (!imported) return;
        const d = normalizeData(imported);
        // Reset cycling to 0 so import feels deterministic
        state.index = 0;
        state.countdownLeft = d.timerStartSeconds;
        state.countdownRunning = false;

        const next = renderAll(d);
        saveStored(next);
        fillEditor(next);
      });

      $("btnClear").addEventListener("click", () => {
        clearStored();
        state.index = 0;
        state.countdownLeft = DEFAULTS.timerStartSeconds;
        state.countdownRunning = false;

        const next = renderAll(DEFAULTS);
        saveStored(next);
        fillEditor(next);
      });

      $("btnClose").addEventListener("click", () => openEditor(false));

      // Hotkeys
      window.addEventListener("keydown", (e) => {
        const key = e.key.toLowerCase();

        if ((e.ctrlKey || e.metaKey) && key === "e"){
          e.preventDefault();
          const isOpen = !$("editor").classList.contains("hidden");
          if (!isOpen){
            const d = normalizeData(loadStored() || state.data || DEFAULTS);
            fillEditor(d);
          }
          openEditor(isOpen);
          return;
        }

        if ((e.ctrlKey || e.metaKey) && key === "t"){
          e.preventDefault();
          setCountdownVisible(!state.countdownVisible);
          // persist visibility toggle
          const d = normalizeData(loadStored() || state.data || DEFAULTS);
          d.timerVisible = state.countdownVisible;
          saveStored(d);
          state.data = d;
          return;
        }

        if ((e.ctrlKey || e.metaKey) && e.code === "Space"){
          e.preventDefault();
          toggleCountdownRun();
          return;
        }
      });

      // Start countdown tick loop
      startCountdownTick();
      renderCountdown();
    })();
  </script>
</body>
</html>
